# StarTraders Complete VPS Frontend Deployment
# Run these commands in VPS SSH terminal after connecting

# ========================================
# IMPORTANT: Run these commands on VPS ONLY
# ========================================

echo "üöÄ Starting StarTraders Frontend Deployment..."

# Step 1: Navigate to project and pull latest changes
cd ~/Startraders
git pull origin main

# Step 2: Navigate to client directory
cd client

# Step 3: Clean previous build
echo "üßπ Cleaning previous build..."
rm -rf build
rm -rf node_modules/.cache

# Step 4: Install dependencies
echo "üì¶ Installing dependencies..."
npm install

# Step 5: Build for production
echo "üèóÔ∏è Building for production..."
npm run build

# Step 6: Verify build completed
echo "üîç Verifying build..."
if [ -d "build" ]; then
    echo "‚úÖ Build completed successfully!"
    ls -la build/
    
    # Step 7: Backup current website (optional)
    echo "üíæ Creating backup of current site..."
    sudo cp -r /var/www/html /var/www/html_backup_$(date +%Y%m%d_%H%M%S)
    
    # Step 8: Clear current website files
    echo "üóëÔ∏è Clearing current website files..."
    sudo rm -rf /var/www/html/*
    
    # Step 9: Copy new build files
    echo "üìÇ Deploying new build files..."
    sudo cp -r build/* /var/www/html/
    
    # Step 10: Set proper permissions
    echo "üîí Setting proper permissions..."
    sudo chown -R www-data:www-data /var/www/html/
    sudo chmod -R 755 /var/www/html/
    
    # Step 11: Test nginx configuration
    echo "üß™ Testing nginx configuration..."
    sudo nginx -t
    
    # Step 12: Reload nginx
    echo "üîÑ Reloading nginx..."
    sudo systemctl reload nginx
    
    # Step 13: Final verification
    echo "‚úÖ Deployment completed!"
    echo ""
    echo "üåê Website URLs to test:"
    echo "http://31.97.207.160"
    echo "https://qxtrand.onrender.com"
    echo "https://qxtrand.onrender.com"
    echo ""
    echo "üîß Check API endpoints in browser console:"
    echo "Should show: https://qxtrand.onrender.com/api/login"
    echo "Should NOT show: startraders-fullstack.onrender.com"
    echo ""
    echo "üìä Build info:"
    du -sh /var/www/html/
    
else
    echo "‚ùå Build failed! Check errors above."
    echo "Try running: npm cache clean --force"
    exit 1
fi

# Step 14: Test API connectivity
echo "üß™ Testing API connectivity..."
curl -I https://qxtrand.onrender.com/api/test 2>/dev/null || echo "‚ö†Ô∏è  API test endpoint not available"

echo "================================================"
echo "‚úÖ StarTraders Frontend Deployment Complete!"
echo "================================================"
